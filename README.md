# magnetic-levitation
magnetic levitation simulator

# 磁懸浮磁學模擬器技術文件

版本: 20260202.01

## 1. 專案簡介

本專案是一個基於 HTML5 Canvas 和 JavaScript 的二維磁學模擬器。它旨在提供一個互動式的環境，讓使用者可以研究磁鐵、鐵塊之間的交互作用，特別是磁懸浮現象。模擬器包含了一個自訂的二維物理引擎，能夠處理物體的運動、磁力、重力、阻力以及精確的碰撞偵測。

---

## 2. 核心技術

*   **渲染引擎**: 使用原生 HTML5 Canvas 2D API 進行圖形繪製。
*   **物理引擎**: 自行開發的二維剛體物理引擎，其特點如下：
    *   **時間積分**: 採用 **子步驟積分 (Sub-step Integration)** 方法，將每一影格的計算拆分為多個子步驟，以確保在高速或高力場環境下的模擬穩定性。
    *   **碰撞偵測**: 採用 **分離軸定理 (Separating Axis Theorem, SAT)**，能夠精確偵測旋轉矩形之間的碰撞，並計算出最小推開向量 (MTV) 以解決物體重疊問題。
*   **使用者互動**: 透過滑鼠事件和 HTML DOM 元素（按鈕、滑桿）提供豐富的互動功能。

---

## 3. 程式碼結構與執行流程

程式碼完全包含在單一 HTML 檔案中，主要分為三個部分：HTML 結構、CSS 樣式和 JavaScript 腳本。

### 3.1 HTML 結構 (`<body>`)

*   `#sidebar`: 左側的控制面板，包含所有互動按鈕和滑桿。
    *   `.section`: 將側邊欄劃分為不同功能區塊（研究元件、物理環境、觀測與佈局、物件屬性）。
*   `#canvasContainer`: 右側的模擬區域。
    *   `#simCanvas`: 用於繪製所有模擬內容的畫布。
    *   `#hud`: 顯示即時資訊（如滑鼠位置的磁場強度）的抬頭顯示器。

### 3.2 JavaScript 腳本 (`<script>`)

#### A. 全域變數與初始化

*   `canvas`, `ctx`: Canvas 元素及其 2D 渲染上下文。
*   `width`, `height`: 畫布的寬度和高度。
*   `objects`: 儲存場景中所有 `MagObj` 物件的陣列。
*   `selected`: 當前被使用者選中的 `MagObj` 物件。
*   `isSimulating`, `useGravity`: 控制物理模擬和重力是否啟用的布林標記。
*   `mouse`: 儲存滑鼠座標和按鍵狀態的物件。

程式啟動時，會呼叫 `resize()` 函數來設定畫布大小，並啟動主迴圈 `loop()`。

#### B. 主迴圈 (Main Loop)

程式的執行核心是 `loop()` 函數，它透過 `requestAnimationFrame(loop)` 不斷重複執行。

1.  **`updatePhysics()`**: 呼叫物理引擎，計算所有物體的狀態（此為核心，詳見下一節）。
2.  **清除畫布**: `ctx.fillRect()` 用背景色清空整個畫布。
3.  **繪製輔助線**: 如果啟用，則呼叫 `drawFieldLines()` 繪製磁力線。
4.  **繪製物件**: 遍歷 `objects` 陣列，呼叫每個物件的 `draw()` 方法。
5.  **更新 HUD**: 更新抬頭顯示器的資訊。
6.  **遞迴呼叫**: `requestAnimationFrame(loop)` 請求瀏覽器在下一次重繪前呼叫 `loop`。

#### C. 物理引擎 (`updatePhysics`)

這是模擬器最複雜的部分，採用子步驟積分來保證穩定性。

1.  **設定時間步長**:
    *   `timeStep`: 固定為 1/60 秒。
    *   `subSteps`: 將 `timeStep` 分割為 10 個子步驟。
2.  **子步驟迴圈**: `for (let i = 0; i < subSteps; i++)`
    *   **`applyForces(subTimeStep)`**: 計算所有施加在物體上的力（磁力、重力），並根據 `F=ma` 更新物體的加速度，進而改變速度 `vx`, `vy`, `vAng`。
    *   **`integrate(subTimeStep)`**: 根據目前的速度更新物體的位置 `x`, `y` 和角度 `angle`。此步驟同時也應用空氣阻尼。
    *   **`solveCollisions()`**: 處理所有物體之間的碰撞，防止它們互相穿透。

#### D. 核心類別與函數

*   **`MagObj` Class**:
    *   描述一個磁性物件（磁鐵或鐵塊）的屬性，如位置、大小、角度、強度、速度、質量等。
    *   `getPoles()`: 計算並返回磁鐵的 N/S 極點在世界座標系中的位置。
    *   `draw()`: 將物件自身繪製到 Canvas 上。

*   **`getFieldAt(x, y, exclude)`**:
    *   **用途**: 計算空間中任意一點 `(x, y)` 的磁場向量 `(bx, by)`。
    *   **原理**: 遍歷場景中所有磁鐵，將每個磁極在該點產生的磁場（遵循平方反比定律）進行向量疊加。
    *   **軟化因子**: 公式中加入了 `softeningFactor`，避免因距離過近導致力趨於無窮大，這是維持模擬穩定的關鍵之一。

*   **碰撞偵測模組 (SAT)**:
    *   `checkAndResolveCollision(obj1, obj2)`: 偵測 `obj1` 和 `obj2` 是否碰撞。
    *   `getVertices(obj)`: 獲取旋轉後矩形的四個頂點座標。
    *   `getAxes(vertices)`: 獲取矩形的所有分離軸（即邊的法向量）。
    *   `project(vertices, axis)`: 將矩形的所有頂點投影到一個軸上，並返回投影的最小值和最大值。
    *   **執行流程**:
        1. 獲取兩個矩形的頂點和所有分離軸。
        2. 遍歷所有軸，將兩個矩形都投影到該軸上。
        3. 如果在任何一個軸上，兩個矩形的投影沒有重疊，則它們沒有碰撞，函數提前返回。
        4. 如果所有軸的投影都發生了重疊，則判定為碰撞。
        5. 找出重疊量最小的軸和重疊量，這就是 **最小推開向量 (MTV)**。
        6. 將兩個物體沿 MTV 的方向推開，使其剛好不再重疊。
        7. 進行簡單的碰撞速度響應。

#### E. 使用者互動函數

*   `addObj(type)`: 新增一個物件。
*   `select(obj)`: 選取一個物件，並在右側屬性面板顯示其資訊。
*   `updateProp()`: 當使用者在屬性面板修改滑桿時，更新被選物件的屬性。
*   `saveConfig()` / `loadConfig()`: 將當前場景物件和設定序列化為 JSON 檔案進行儲存，或從 JSON 檔案讀取。
*   滑鼠事件 (`onmousedown`, `onmousemove`, `onmouseup`): 處理物件的選取和拖曳。

---

## 4. 未來可擴充方向

*   **效能優化**: 當物件數量過多時，可以引入空間分割（如四叉樹）來加速磁場計算和碰撞偵測。
*   **更真實的物理**:
    *   實現更精確的轉動慣量。
    *   引入靜摩擦力和動摩擦力。
*   **3D 擴充**: 將目前的 2D 引擎擴充為 3D 引擎。
*   **視覺化**: 增加更多磁場視覺化方式，如向量場圖。

